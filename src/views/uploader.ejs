<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
  </head>
  <body>
    <!-- Logout Button -->
    <div id="loggedInButtons">
      <form id="logOutForm" action="/uploader/logOut" method="get">
        <button type="submit">Log Out</button>
      </form>
      <!-- File Upload -->
      <h2>Upload a File</h2>
      <form
        action="/uploader/upload/"
        method="post"
        enctype="multipart/form-data"
      >
        <div class="form-group">
          <label for="selectedFile">Choose file:</label>
          <input type="file" id="selectedFile" name="selectedFile" required />
        </div>
        <!-- keep context so controller can redirect back -->
        <input type="hidden" name="folderId" value="<%= folder.id %>" />
        <button type="submit">Upload File</button>
      </form>
      <!-- Go up a folder  -->
      <% if (folder.parentId) { %>
      <a href="/uploader/folder/<%= folder.parentId %>">&#8617; Go Back</a>
      <% } %>
      <!-- Create Folder -->
      <form id="createFolder" action="/uploader/folder" method="post">
        <input
          type="text"
          name="createFolderName"
          placeholder="Folder Name"
          required
        />
        <input type="hidden" name="parentId" value="<%= folder.id %>" />
        <button type="submit">Create Folder</button>
      </form>

      <!-- Error Message Display -->
      <% if (errorMessage) { %>
      <div class="errorMessage"><%= errorMessage %></div>
      <% } %>
    </div>

    <div id="displayContainer">
      <!-- Display folders & files -->
      <% if (!folder.children || folder.children.length === 0) { %>
      <p>This folder has no subfolders.</p>
      <% } else { %> <% folder.children.forEach(child => { %>
      <div class="folderBlock">
        <!-- Folder Button -->
        <form
          class="folderNavForm"
          action="/uploader/folder/<%= child.id %>"
          method="get"
        >
          <button class="folderButton" type="submit">
            <span class="folderName"><%= child.name %></span>
          </button>
        </form>
        <!-- Details -->
        Created: <%= child.contentsCreatedAt %>
        <!-- Edit Button -->
        <form
          class="editForm"
          action="/uploader/folder/<%= child.id%>/edit"
          method="post"
        >
          <input
            type="text"
            name="newName"
            placeholder="New Folder Name"
            minlength="1"
            required
          />
          <input type="hidden" name="folderId" value="<%= folder.id %>" />
          <button type="submit">Edit</button>
        </form>
        <!-- Delete Button -->
        <form action="/uploader/folder/<%= child.id %>/delete" method="post">
          <button type="submit" onclick="return confirm('Delete this folder?')">
            Delete
          </button>
        </form>
      </div>
      <% }) %> <% } %>

      <h2>Files</h2>
      <% if (!folder.files || folder.files.length === 0) { %>
      <p>No files.</p>
      <% } else { %> <% folder.files.forEach(file => { %>
      <div class="file-block">
        <span
          ><a href="/uploader/file/<%= file.id %>"
            ><%= file.originalName || file.fileName || file.id %></a
          ></span
        >
        <%= file.contentsSize %> • Uploaded: <%= file.contentsCreatedAt %> •
        <!-- <a href="  %= file.url %   ">Download</a> -->
        <form
          class="downloadForm"
          action="/uploader/file/<%= file.id %>/download/"
          method="get"
        >
          <button type="submit">Download</button>
        </form>
      </div>
      <% }) } %>
    </div>

    <!-- Footer -->
    <%- include('footer'); %>

    <script src="/scripts/uploaderScripts.js"></script>
  </body>
</html>
